{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/e8f79a33-6569-4dc8-a2b6-3960bb4c53a8')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/e8f79a33-6569-4dc8-a2b6-3960bb4c53a8')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "_CSGP: Interacting With Master Password",
                "description": "Descripton: This alert detects repeated attempts to access the master.passwd file from the same account and device within an hour, which may indicate suspicious activity, such as privilege escalation or reconnaissance. The CommandsExecuted field provides specific command lines used, helping identify potential malicious methods or unusual patterns. We should verify if the access is legitimate and, if not, escalate for further investigation.\nHandling Guidance: Investigate related DeviceProcessEvents and other recent activity by the AccountName to assess if there's suspicious behavior, and contact the user to verify if the action was legitimate. If evidence of compromise is found, isolate the device from the network immediately.",
                "severity": "Medium",
                "enabled": true,
                "query": "// Analytic Rule Name: _CSPG: Interacting With Master Password\r\n// Contributor: Kamran Ahmadjan\r\n// Reviewer: James Kim\r\n// Reference:\r\n//\r\n// Description: This alert detects repeated attempts to access the master.passwd file from the same account and device within an hour, which may indicate suspicious activity, such as privilege escalation or reconnaissance. The CommandsExecuted field provides specific command lines used, helping identify potential malicious methods or unusual patterns. Analysts should verify if the access is legitimate and, if not, escalate for further investigation.\r\n// Handling Guidance: Investigate related DeviceProcessEvents and other recent activity by the AccountName to assess if there's suspicious behavior, and contact the user to verify if the action was legitimate. If evidence of compromise is found, isolate the device from the network immediately.\r\n//\r\n// Change notes\r\n// ------------\r\n// \r\nDeviceProcessEvents\r\n| where ProcessCommandLine has \"master.passwd\"\r\n| summarize AttemptCount = count(), CommandsExecuted = make_set(ProcessCommandLine) by AccountName, DeviceName, bin(TimeGenerated, 1h)\r\n| where AttemptCount > 1\r\n| project TimeGenerated, DeviceName, AccountName, AttemptCount, CommandsExecuted\r\n",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "CredentialAccess"
                ],
                "techniques": [
                    "T1555"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "DeviceName"
                            }
                        ]
                    },
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "Name",
                                "columnName": "AccountName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "CommandLine",
                                "columnName": "CommandsExecuted"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}