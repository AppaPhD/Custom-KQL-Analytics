{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/c3ea66d3-92ac-451f-8ddf-877b2276bcde')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/c3ea66d3-92ac-451f-8ddf-877b2276bcde')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "_CSGP: Endpoint - Probable AD Recon Tool Usage",
                "description": "Identifies the host and account that executed AdFind by hash and filename in addition to common and unique flags that are used by many threat actors in discovery.\n\nHandling guidance: Examine ProcessCommandLines and the AccountName. Determine if the person has a legitimate reason for running the commands. Ex. if a sales person running commands related to AD recon activity, escalate the activity.",
                "severity": "Medium",
                "enabled": true,
                "query": "// Analytic Rule Name:_DEV: Probable AD Recon Tool Usage\n//\n// Contributor: Mohamed Elgendy\n// Source: https://github.com/Azure/Azure-Sentinel\n// Reviewer: Lucas Trainer\n//\n// Description: Looking for AD Recon activity \n//\n// Handling guidance: Examine ProcessCommandLines and the AccountName. Determine if the person has a legitimate  \n// reason for running the commands. Ex. if a sales person running commands related to AD recon activity, esclate \n// to the endpoint team. \n// Reference: https://github.com/Azure/Azure-Sentinel\n//\n//// Change notes\n// ------------\n// 11/18/24 James Kim - Excluding nodejs and domainList.ts which is used by the devs working on CoStar Sync\n//\n// Query: \nlet args = dynamic([\"objectcategory\", \"domainlist\", \"dcmodes\", \"adinfo\", \"trustdmp\", \"computers_pwdnotreqd\", \"Domain Admins\", \"objectcategory=person\", \"objectcategory=computer\", \"objectcategory=*\", \"dclist\"]);\nlet parentProcesses = dynamic([\"pwsh.exe\", \"powershell.exe\", \"cmd.exe\"]);\nlet excludeAdmins = dynamic([\"jbartola\"]); // Exclude Jarad (USHD Admin);\nlet excludeDevices = dynamic([\"dcjbartola4.us.costar.local\"]); // Exclude Jarad (USHD Admin);\nDeviceProcessEvents\n//looks for execution from a shell\n| where InitiatingProcessFileName in (parentProcesses)\n// main filter\n| where FileName =~ \"AdFind.exe\" or SHA256 == \"c92c158d7c37fea795114fa6491fe5f145ad2f8c08776b18ae79db811e8e36a3\"\n    // AdFind common Flags to check for from various threat actor TTPs\n    or ProcessCommandLine has_any (args)\n| where not (AccountName has_any (excludeAdmins)) \n    and not (ProcessCommandLine has_any (excludeAdmins)) \n    and not(DeviceName has_any (excludeDevices))\n| where not(ProcessVersionInfoOriginalFileName == \"node.exe\" and ProcessCommandLine has \"domainList.ts\") //excluding costar sync\n| extend\n    AccountCustomEntity = AccountName,\n    HostCustomEntity = DeviceName,\n    ProcessCustomEntity = InitiatingProcessFileName,\n    CommandLineCustomEntity = ProcessCommandLine,\n    AlgorithmCustomEntity = \"SHA256\",\n    FileHashCustomEntity = SHA256",
                "queryFrequency": "PT15M",
                "queryPeriod": "PT15M",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "Discovery"
                ],
                "techniques": [
                    "T1018"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": "c63ae777-d5e0-4113-8c9a-c2c9d3d09fcd",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "Selected",
                        "groupByEntities": [
                            "Host"
                        ],
                        "groupByAlertDetails": [
                            "DisplayName"
                        ],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "AccountCustomEntity"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "HostCustomEntity"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ProcessCustomEntity"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "CommandLineCustomEntity"
                            }
                        ]
                    },
                    {
                        "entityType": "FileHash",
                        "fieldMappings": [
                            {
                                "identifier": "Algorithm",
                                "columnName": "AlgorithmCustomEntity"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "FileHashCustomEntity"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.1"
            }
        }
    ]
}