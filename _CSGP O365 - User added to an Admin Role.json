{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/795ad5bd-dbf6-4697-8444-68a78070f3b0')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/795ad5bd-dbf6-4697-8444-68a78070f3b0')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "_CSGP: O365 - User added to an Admin Role",
                "description": "Added a user to an admin role in Office 365. Technique: T1098.  Audit for suspicious behavior \n\nHandling Guidance: Reach out to the user in question to determine why this action was taken.",
                "severity": "Medium",
                "enabled": true,
                "query": "// Contributor: Obadiah Bridges\r\n// Source:  \r\n// Reviewer: \r\n//\r\n// Description: Added a user to an admin role in Office 365. Technique: T1098.  Audit for suspicious behavior\r\n// Handling Guidance: Reach out to the user in question to determine why this action was taken. \r\n// \r\n// Change notes\r\n// ------------\r\n// 4/26/2023 Obadiah Bridges - Updated boilerplate, handling guidance, title and moved to production. \r\n// 6/20/2023 Obadiah Bridges - this query is not properly gathering data. The \"OfficeActivity\" table is not the correct table to look at. Will have to rework this query to use the AuditLogs table and ensure that it can be created into a high fidelity alert. \r\n//\r\n// Query:\r\nOfficeActivity\r\n| where ((Operation == \"Add member to role\") and (ResultStatus == \"Success\") and (ModifiedProperties contains \"admin\"))\r\n| extend AccountCustomEntity = UserId\r\n| extend IPCustomEntity = ClientIP",
                "queryFrequency": "PT12H",
                "queryPeriod": "PT12H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "Persistence"
                ],
                "techniques": [
                    "T1098"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5M",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "AccountCustomEntity"
                            }
                        ]
                    },
                    {
                        "entityType": "IP",
                        "fieldMappings": [
                            {
                                "identifier": "Address",
                                "columnName": "IPCustomEntity"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}