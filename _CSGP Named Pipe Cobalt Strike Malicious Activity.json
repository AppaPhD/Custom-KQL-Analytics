{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/9bfe8da4-9cc6-48af-ae71-4f0f54d3ce93')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/9bfe8da4-9cc6-48af-ae71-4f0f54d3ce93')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "_CSGP: Named Pipe Cobalt Strike Malicious Activity",
                "description": "This query is designed to detect suspicious named pipe activity in and on devices, potentially indicative of malicious software or framework operations like Cobalt Strike. It utilizes a list of known named pipe patterns associated with default and malleable Cobalt Strike configurations, as well as regex patterns to differentiate between malicious usage and legitimate application processes. It focuses on unusual activity such as hexadecimal strings in pipe names, which are typical in malicious operations. This helps in identifying potential threats by monitoring named pipe events.\n\n Handling Guidance: Examine the command line and compare the activity to a known good baseline to determine if it aligns with typical behavior, if malicious behavior is found immediately isolate this machine from the network and look for processes relating up to the incident for IOC grouping and for further root cause analysis",
                "severity": "High",
                "enabled": true,
                "query": "  // Analytic Rule Name: CSGP: Named Pipe Malicious Activity\r\n// Contributor: Kamran Ahmadjan\r\n// Reviewer: \r\n// Reference:\r\n//\r\n// Description: This query is designed to detect suspicious named pipe activity in and on devices, potentially indicative of malicious software or framework operations like Cobalt Strike. It utilizes a list of known named pipe patterns associated with default and malleable Cobalt Strike configurations, as well as regex patterns to differentiate between malicious usage and legitimate application processes. It focuses on unusual activity such as hexadecimal strings in pipe names, which are typical in malicious operations. This helps in identifying potential threats by monitoring named pipe events.\r\n// Handling Guidance: Examine the command line and compare the activity to a known good baseline to determine if it aligns with typical behavior, if malicious behavior is found immediately isolate this machine from the network and look for processes relating up to the incident for IOC grouping and for further root cause analysis\r\n//\r\n// Change notes\r\n// ------------\r\n// \r\n  let CobaltStrikeDefaults = dynamic([@\"msagent_\", @\"MSSE-\", @\"postex_\", @\"status_\", @\"mypipe-f\", @\"mypipe-h\",@\"ntsvcs_\",@\"scerpc_\", @\"mojo.5688.8052.\"]);\r\nlet CobaltStrikeMallable = dynamic([@\"win_svc\", @\"ntsvcs\", @\"scerpc\", @\"status_\", @\"SearchTextHarvester\", @\"DserNamePipe\",@\"wkssvc_\",@\"scerpc_\", @\"spoolss_\",@\"CatalogChangeListener\",@\"fullduplex_\",@\"demoagent_\",@\"PGMessagePipe\",@\"MsFteWds\",@\"postex_ssh_\",@\"windows.update.manager\",@\"\\f4c3\",@\"\\f53f\",@\"halfduplex_\"]);\r\nDeviceEvents\r\n| where ActionType == \"NamedPipeEvent\"\r\n| extend AdditionalFields = parse_json(AdditionalFields)\r\n| extend ThreadId = tostring(AdditionalFields.ThreadId)\r\n| extend PipeName = tostring(AdditionalFields.PipeName)\r\n| extend InitiatingPID = tostring(InitiatingProcessId)\r\n| extend InitiatingParentPID = tostring(InitiatingProcessParentId)\r\n| where PipeName !has \"kyoceradocumentsolutions\"\r\n| where InitiatingProcessFileName !has \"kdservice.exe\" or InitiatingProcessFileName !has \"kdsstm.exe\"\r\n| where PipeName has_any (CobaltStrikeDefaults) or\r\n        (PipeName matches regex @\"\\\\mojo\\.\\d+\\.\\d+\\.\" and not(PipeName matches regex @\"\\\\mojo\\.\\d+\\.\\d+\\.\\d+$\" or PipeName has InitiatingPID or PipeName has InitiatingParentPID or PipeName has ThreadId)) or\r\n        (PipeName matches regex @\"\\\\(edge|chrome)\\.sync\\.\\d+\\.\\d+\\.\" and not(PipeName matches regex @\"\\\\(edge|chrome|edge\\.sync|chrome\\.sync)\\.\\d+\\.\\d+\\.\\d+$\" or PipeName has InitiatingPID or PipeName has InitiatingParentPID or PipeName has ThreadId)) or\r\n        (PipeName matches regex @\"\\\\PSHost\\.\\d+\\.\" and not(PipeName matches regex @\"\\\\PSHost\\.\\d+\\.\\d+\\.\" or PipeName has InitiatingPID or PipeName has InitiatingParentPID)) or\r\n        (PipeName matches regex @\"\\\\crashpad_\" and not(PipeName matches regex @\"\\\\crashpad_\\d+_[A-Z]+\" or PipeName has InitiatingPID or PipeName has InitiatingParentPID)) or\r\n        (PipeName matches regex @\"\\\\cubeb-pipe-\" and not(PipeName matches regex @\"\\\\cubeb-pipe-\\d+_[0-9]{1-3}+\" or PipeName has InitiatingPID)) or\r\n        (PipeName has_any (CobaltStrikeMallable) and PipeName matches regex @\"[a-fA-F0-9]{2,10}$\") or\r\n        (PipeName matches regex @\"\\\\pipe\\\\[0-9a-f]{7,10}\" or PipeName matches regex @\"\\\\pipe\\\\[0-9a-f]{8}\") or\r\n        (PipeName matches regex @\"MSSE-[0-9a-f]{3}-server\") or\r\n        (PipeName matches regex @\"status_[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"postex_ssh_[0-9a-f]{4}\") or\r\n        (PipeName matches regex @\"msagent_[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"postex_[0-9a-f]{4}\") or\r\n        (PipeName matches regex @\"mojo\\.5688\\.8052\\.183894939787088877[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"mojo\\.5688\\.8052\\.35780273329370473[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"wkssvc[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"ntsvcs[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"DserNamePipe[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"SearchTextHarvester[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"ntsvcs_zloader\\.profile\") or\r\n        (PipeName matches regex @\"scerpc_zloader\\.profile\") or\r\n        (PipeName matches regex @\"mypipe-f[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"mypipe-h[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"windows\\.update\\.manager[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"windows\\.update\\.manager[0-9a-f]{3}\") or\r\n        (PipeName matches regex @\"ntsvcs_[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"scerpc_[0-9a-f]{2}\") or\r\n        (PipeName matches regex @\"scerpc[0-9a-f]{2}\")\r\n| project TimeGenerated, DeviceName, InitiatingProcessAccountName, PipeName, InitiatingProcessCommandLine, InitiatingProcessFileName, InitiatingProcessFolderPath, MachineGroup, AdditionalFields, ProcessCommandLine\r\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5M",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "PrivilegeEscalation",
                    "DefenseEvasion",
                    "Execution"
                ],
                "techniques": [
                    "T1055"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": false,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "Name",
                                "columnName": "InitiatingProcessAccountName"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "DeviceName"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "CommandLine",
                                "columnName": "InitiatingProcessCommandLine"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "CommandLine",
                                "columnName": "ProcessCommandLine"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}